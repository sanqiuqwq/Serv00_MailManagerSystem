{% extends "admin/base.html" %}

{% block title %}用户管理 - {{ site_settings.site_name }}{% endblock %}

{% block admin_content %}
<h2>用户管理</h2>
<div class="mb-4">
    <form method="GET" class="row g-2">
        <div class="col-md-4">
            <input type="text" class="form-control" name="search" placeholder="搜索用户名/邮箱/UID" value="{{ search_query }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">搜索</button>
        </div>
        {% if search_query %}
        <div class="col-md-2">
            <a href="{{ url_for('admin_users') }}" class="btn btn-secondary w-100">清除</a>
        </div>
        {% endif %}
    </form>
</div>
<div class="table-responsive mt-4">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>UID</th>
                <th>用户名</th>
                {% if current_user.is_owner() %}
                <th>邮箱</th>
                {% endif %}
                <th>用户组</th>
                <th>状态</th>
                <th>邮箱数</th>
                <th>注册时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.uid }}</td>
                <td>{{ user.username }}{% if user.role == 'owner' %} <span class="badge bg-danger">Owner</span>{% elif user.role == 'pro' %} <span class="badge bg-warning">Pro</span>{% endif %}</td>
                {% if current_user.is_owner() %}
                <td>{{ user.email }}</td>
                {% endif %}
                <td>
                    {% if user.role != 'owner' or current_user.is_owner() %}
                    <form method="POST" action="{{ url_for('admin_change_role', user_id=user.id) }}" style="display: inline;">
                        <select name="role" class="form-select form-select-sm" style="width: auto; display: inline;">
                            <option value="user" {% if user.role == 'user' %}selected{% endif %}>普通用户</option>
                            <option value="pro" {% if user.role == 'pro' %}selected{% endif %}>Pro用户</option>
                            {% if current_user.is_owner() %}
                            <option value="owner" {% if user.role == 'owner' %}selected{% endif %}>Owner</option>
                            {% endif %}
                        </select>
                        {% if user.role == 'pro' %}
                        <select name="duration" class="form-select form-select-sm" style="width: auto; display: inline;">
                            <option value="30">30天</option>
                            <option value="90">90天</option>
                            <option value="365">365天</option>
                            <option value="permanent">永久</option>
                        </select>
                        {% endif %}
                        <button type="submit" class="btn btn-sm btn-info">修改</button>
                    </form>
                    {% else %}
                    {% if user.role == 'owner' %}Owner{% elif user.role == 'pro' %}Pro用户{% else %}普通用户{% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if user.is_banned %}
                    <span class="badge bg-danger">已封禁</span>
                    {% elif user.is_verified %}
                    <span class="badge bg-success">已验证</span>
                    {% else %}
                    <span class="badge bg-warning">未验证</span>
                    {% endif %}
                </td>
                <td>{{ user.get_email_count() }}/{{ user.get_max_emails() }}<br>
                    {% if user.role != 'owner' or current_user.is_owner() %}
                    <form method="POST" action="{{ url_for('admin_update_max_emails', user_id=user.id) }}" style="display: inline;">
                        <div class="input-group input-group-sm" style="width: 120px;">
                            <input type="number" name="max_emails" class="form-control" value="{{ user.max_emails }}" min="1" required>
                            <button type="submit" class="btn btn-sm btn-success">更新</button>
                        </div>
                    </form>
                    {% endif %}
                </td>
                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    {% if user.role != 'owner' or current_user.is_owner() %}
                        {% if user.role != 'owner' %}
                            {% if user.is_banned %}
                            <a href="{{ url_for('admin_unban_user', user_id=user.id) }}" class="btn btn-sm btn-success">解封</a>
                            {% else %}
                            <a href="{{ url_for('admin_ban_user', user_id=user.id) }}" class="btn btn-sm btn-warning">封禁</a>
                            {% endif %}
                        <a href="{{ url_for('admin_delete_user', user_id=user.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除此用户吗？')">删除</a>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if search_query %}
<div class="mt-3 alert alert-info">
    搜索 "{{ search_query }}" 找到 {{ users|length }} 个结果
</div>
{% endif %}
{% endblock %}
